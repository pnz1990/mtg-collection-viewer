<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deck Checker - MTG Collection Viewer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>MTG Collection Viewer</h1>
    <div class="stats">
      <span>Deck Checker</span>
      <select id="theme-select" class="theme-select">
        <option value="">Dark (Default)</option>
        <option value="azorius">Azorius</option>
        <option value="dimir">Dimir</option>
        <option value="rakdos">Rakdos</option>
        <option value="gruul">Gruul</option>
        <option value="selesnya">Selesnya</option>
        <option value="orzhov">Orzhov</option>
        <option value="izzet">Izzet</option>
        <option value="golgari">Golgari</option>
        <option value="boros">Boros</option>
        <option value="simic">Simic</option>
      </select>
    </div>
  </header>

  <div class="deck-checker">
    <div class="deck-input">
      <h2>Check Deck Against Your Collection</h2>
      <p>Paste a Moxfield deck URL or deck list below</p>
      <input type="text" id="deck-url" placeholder="https://www.moxfield.com/decks/..." class="deck-url-input">
      <button type="button" id="check-url" class="check-btn">Check Moxfield Deck</button>
      <div class="divider">— or paste deck list —</div>
      <textarea id="deck-list" placeholder="1 Sol Ring&#10;1 Command Tower&#10;1 Lightning Bolt&#10;..." class="deck-list-input"></textarea>
      <button type="button" id="check-list" class="check-btn">Check Deck List</button>
    </div>
    
    <div id="deck-results" class="deck-results hidden">
      <div class="results-summary">
        <div class="summary-owned">
          <span class="summary-count" id="owned-count">0</span>
          <span class="summary-label">Cards You Own</span>
        </div>
        <div class="summary-missing">
          <span class="summary-count" id="missing-count">0</span>
          <span class="summary-label">Cards Missing</span>
        </div>
        <div class="summary-percent">
          <span class="summary-count" id="owned-percent">0%</span>
          <span class="summary-label">Complete</span>
        </div>
      </div>
      
      <div class="results-columns">
        <div class="results-column owned">
          <h3>✓ Cards You Own</h3>
          <div id="owned-list" class="card-list"></div>
        </div>
        <div class="results-column missing">
          <h3>✗ Cards Missing</h3>
          <div id="missing-list" class="card-list"></div>
        </div>
      </div>
    </div>
  </div>

  <a href="index.html" class="back-link">← Back to Collection</a>

  <script>
    // Theme switcher
    const themeSelect = document.getElementById('theme-select');
    const savedTheme = localStorage.getItem('mtg-theme') || '';
    document.documentElement.dataset.theme = savedTheme;
    themeSelect.value = savedTheme;
    themeSelect.addEventListener('change', () => {
      document.documentElement.dataset.theme = themeSelect.value;
      localStorage.setItem('mtg-theme', themeSelect.value);
    });

    let collectionNames = new Set();

    // Load collection and extract card names
    async function loadCollection() {
      const response = await fetch('Collection.csv');
      const text = await response.text();
      const lines = text.split('\n').slice(1);
      
      lines.forEach(line => {
        if (!line.trim()) return;
        const name = line.split(',')[0].replace(/^"|"$/g, '').toLowerCase();
        collectionNames.add(name);
      });
    }

    function parseDeckList(text) {
      const cards = [];
      const lines = text.trim().split('\n');
      
      for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed || trimmed.startsWith('//') || trimmed.startsWith('#')) continue;
        
        // Match patterns like "1 Card Name" or "1x Card Name"
        const match = trimmed.match(/^(\d+)x?\s+(.+?)(?:\s+\([^)]+\))?(?:\s+\d+)?$/i);
        if (match) {
          cards.push({ quantity: parseInt(match[1]), name: match[2].trim() });
        }
      }
      return cards;
    }

    function checkDeck(deckCards) {
      const owned = [];
      const missing = [];
      
      for (const card of deckCards) {
        const nameLower = card.name.toLowerCase();
        // Check if we own this card (any version)
        if (collectionNames.has(nameLower)) {
          owned.push(card);
        } else {
          missing.push(card);
        }
      }
      
      return { owned, missing };
    }

    function displayResults(owned, missing) {
      const results = document.getElementById('deck-results');
      results.classList.remove('hidden');
      
      const totalCards = owned.length + missing.length;
      const ownedCount = owned.reduce((s, c) => s + c.quantity, 0);
      const missingCount = missing.reduce((s, c) => s + c.quantity, 0);
      const percent = totalCards > 0 ? Math.round((owned.length / totalCards) * 100) : 0;
      
      document.getElementById('owned-count').textContent = owned.length;
      document.getElementById('missing-count').textContent = missing.length;
      document.getElementById('owned-percent').textContent = percent + '%';
      
      document.getElementById('owned-list').innerHTML = owned
        .map(c => `<div class="deck-card owned">${c.quantity}x ${c.name}</div>`)
        .join('') || '<div class="empty">No cards owned</div>';
      
      document.getElementById('missing-list').innerHTML = missing
        .map(c => `<div class="deck-card missing">${c.quantity}x ${c.name}</div>`)
        .join('') || '<div class="empty">You own all cards!</div>';
    }

    async function checkMoxfieldDeck(url) {
      // Extract deck ID from URL
      const match = url.match(/moxfield\.com\/decks\/([a-zA-Z0-9_-]+)/);
      if (!match) {
        alert('Invalid Moxfield URL');
        return;
      }
      
      const deckId = match[1];
      
      try {
        const response = await fetch(`https://api2.moxfield.com/v2/decks/all/${deckId}`);
        if (!response.ok) throw new Error('Failed to fetch deck');
        
        const data = await response.json();
        const deckCards = [];
        
        // Extract cards from mainboard, sideboard, commanders, etc.
        const boards = ['mainboard', 'sideboard', 'commanders', 'companions'];
        for (const board of boards) {
          if (data[board]) {
            for (const [name, cardData] of Object.entries(data[board])) {
              deckCards.push({ quantity: cardData.quantity, name: cardData.card.name });
            }
          }
        }
        
        const { owned, missing } = checkDeck(deckCards);
        displayResults(owned, missing);
        
      } catch (e) {
        alert('Could not fetch Moxfield deck. CORS may be blocking the request.\n\nTry copying the deck list from Moxfield and pasting it in the text area instead.');
        console.error(e);
      }
    }

    // Event listeners
    document.getElementById('check-url').addEventListener('click', () => {
      const url = document.getElementById('deck-url').value.trim();
      if (url) checkMoxfieldDeck(url);
    });

    document.getElementById('check-list').addEventListener('click', () => {
      const text = document.getElementById('deck-list').value.trim();
      if (!text) return;
      
      const deckCards = parseDeckList(text);
      const { owned, missing } = checkDeck(deckCards);
      displayResults(owned, missing);
    });

    // Initialize
    loadCollection();
  </script>
</body>
</html>
